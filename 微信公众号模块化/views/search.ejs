<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Search</title>
</head>
<body>
<button id="btn">click me!</button>
<ul id="lists"></ul>

<script src="http://res2.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<!--zepto：是移动端的jQury库，比PC端的jQuery库更小,用法与PC端的jQury相同-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js"></script>
<script>
    $(function () {
        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: '<%= appId %>', // 必填，公众号的唯一标识
            timestamp: '<%= timestamp %>', // 必填，生成签名的时间戳
            nonceStr: '<%= noncestr %>', // 必填，生成签名的随机串
            signature: '<%= signature %>',// 必填，签名
            jsApiList: [
                'updateAppMessageShareData',
                'updateTimelineShareData',
                'startRecord',
                'stopRecord',
                'translateVoice'
            ] // 必填，需要使用的JS接口列表
        });

        wx.ready(function(){
            // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，
            // config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。
            // 对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
        });

        //开始录音，停止录音，翻译录制的音频的逻辑
        //tap：zepto库中封装的移动端触屏事件的方法
        let flag = false;     //用来判断是否在录音
        $('#btn').tap(function () {
            //flag为true，表明在录音，那么停止录音
            if(flag){
                //停止录音的逻辑
                wx.stopRecord({
                    success: function (res) {
                        var localId = res.localId;
                        alert('停止录音');
                        //翻译录音的逻辑
                        wx.translateVoice({
                            localId: localId, // 需要识别的音频的本地Id，由录音相关接口获得
                            isShowProgressTips: 1, // 默认为1，显示进度提示
                            success: function (res) {
                                //发送请求，请求豆瓣的电影数据，存在跨域问题
                                //豆瓣搜索电影接口地址--->ttps://api.douban.com/v2/movie/search?
                                $.getJSON(`https://api.douban.com/v2/movie/search?q=${res.translateResult}&count=9&callback=?`,function (data) {
                                    const {subjects} = data;

                                    const movie = subjects.reduce((pre,cur) => {
                                        return pre +  `<li>
                                                         <img src="${cur.images.small}" alt="${cur.title}">
                                                         <a href="${cur.alt}">${cur.title}</a>
                                                         <p>电影评分：${cur.rating.average}</p>
                                                      </li>`
                                    },'')

                                        wx.updateAppMessageShareData({
                                            title: subjects[0].title, // 分享标题
                                            desc: '电影评分: '+subjects[0].rating.average, // 分享描述
                                            link: '<%= url %>/search', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                            imgUrl: '<%= url %>/glodenEye.jpg', // 分享图标
                                            success: function () {
                                                // 分享成功
                                            },
                                            fail: function (err) {
                                                alert(err);
                                                // 分享失败
                                                alert('分享失败 ');
                                            }
                                        })

                                        wx.updateTimelineShareData({
                                            title: subjects[0].title, // 分享标题
                                            link: '<%= url %>/search', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                            imgUrl: '<%= url %>/glodenEye.jpg', // 分享图标
                                            success: function () {
                                                // 设置成功
                                            }
                                        })
                                        $('#lists').html(movie);
                                })
                            }
                        });
                        flag = false;
                    }
                });
            }else{
                //flag为false,表明没有录音，那么开始录音
                wx.startRecord();
                flag = true;
            }
        })

        //判断当前客户端版本是否支持指定JS接口
        wx.checkJsApi({
            jsApiList: [
                'updateAppMessageShareData',
                'updateTimelineShareData',
                'startRecord',
                'stopRecord',
                'translateVoice'
            ],
            success: function(res) {
                // 以键值对的形式返回，可用的api值true，不可用为false
                // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
                console.log(res);
            }
        });
    })

</script>
</body>
</html>